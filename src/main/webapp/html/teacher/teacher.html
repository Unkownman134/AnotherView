<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师工作台 - Anotherview 编程实训平台</title>
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>

<div>
    <h1>教师工作台</h1>
    <div class="user-info">
        欢迎, <span id="username">教师</span> | <a href="#" onclick="logout()">退出登录</a>
    </div>
</div>

<div>
    <h2>练习列表</h2>

    <div>
        <div>
            <label>选择学期:</label>
            <div id="semester-filter">
            </div>
        </div>

        <div>
            <div>
                <input type="text" id="search-input" placeholder="搜索标题、课程、班级...">
                <button onclick="searchPractice()">搜索</button>
            </div>
            <button class="add-practice-btn" onclick="window.location.href='/Anotherview/html/teacher/teacher-add-practice.html'">添加练习</button>
        </div>

        <table>
            <thead>
            <tr>
                <th>练习标题</th>
                <th>所属课程</th>
                <th>班级</th>
                <th>题目数量</th>
                <th>开始时间</th>
                <th>截止时间</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="practice-list">
            </tbody>
        </table>
        <div id="loading-message" style="display: none;">加载中...</div>
        <div id="no-data-message" style="display: none;">没有找到匹配的练习。</div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script>
    let teacherIdGlobal = null;

    $(document).ready(function () {
        $.get("/Anotherview/api/teacherInfo", function (teacher) {
            if (teacher && teacher.name) {
                $("#username").text(teacher.name);
                teacherIdGlobal = teacher.id;
                loadSemesters();
                loadPractices();
            } else {
                $("#username").text("未知教师");
                alert("无法获取教师信息，请重新登录。");
                window.location.href = "/Anotherview/html/teacher/teacher-login.html";
            }
        }).fail(() => {
            alert("无法获取教师信息，请重新登录。");
            window.location.href = "/Anotherview/html/teacher/teacher-login.html";
        });
    });

    function logout() {
        $.post("/Anotherview/api/teacherLogout", function () {
            alert("已退出登录");
            window.location.href = "/Anotherview/html/teacher/teacher-login.html";
        }).fail(() => {
            alert("退出失败");
        });
    }

    function loadSemesters() {
        $.get("/Anotherview/api/semesters", function(semesters) {
            const $semesterFilter = $("#semester-filter");
            $semesterFilter.empty();
            $semesterFilter.append('<button class="semester-button" data-semester-id="all">全部学期</button>');
            semesters.forEach(semester => {
                $semesterFilter.append(`<button class="semester-button" data-semester-id="${semester.id}">${semester.name}</button>`);
            });

            $(".semester-button").click(function() {
                $(".semester-button").removeClass("active");
                $(this).addClass("active");
                loadPractices(); // Reload practices when semester filter changes
            });

            $("#semester-filter button:first").addClass("active"); // Select "全部学期" by default
        });
    }

    function loadPractices() {
        $("#loading-message").show();
        $("#no-data-message").hide();
        $("#practice-list").empty();

        const searchTerm = $("#search-input").val().trim();
        const selectedSemesterId = $("#semester-filter button.active").data("semester-id");


        const apiUrl = '/Anotherview/api/teacher/practices';
        const params = {};

        if (selectedSemesterId && selectedSemesterId !== 'all') {
            params.semesterId = selectedSemesterId;
        }

        if (searchTerm) {
            params.searchTerm = searchTerm;
        }

        $.ajax({
            url: apiUrl,
            type: 'GET',
            dataType: 'json',
            data: params,
            success: function (practices) {
                $("#loading-message").hide();
                if (practices.length === 0) {
                    $("#no-data-message").show();
                } else {
                    renderPractices(practices);
                }
            },
            error: function (xhr, status, error) {
                $("#loading-message").hide();
                $("#no-data-message").text("加载练习失败。").show();
                console.error("Error loading practices:", error);
                alert('加载练习失败: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText));
            }
        });
    }

    function searchPractice() {
        loadPractices();
    }

    function renderPractices(practices) {
        const $practiceListTbody = $("#practice-list");
        $practiceListTbody.empty();

        practices.forEach(practice => {
            const statusDisplay = getStatusDisplay(practice.status);
            const row = `
                    <tr>
                        <td>${practice.title}</td>
                        <td>${practice.lessonName || '未知课程'}</td>
                        <td>${practice.classof}</td>
                        <td>${practice.questionNum || 0}</td>
                        <td>${formatDisplayDateTime(practice.startAt)}</td>
                        <td>${formatDisplayDateTime(practice.endAt)}</td>
                        <td><span>${statusDisplay.text}</span></td>
                        <td>
                            <button onclick="editPractice(${practice.id})">修改</button>
                            <button onclick="openExtendTimeModal(${practice.id}, '${practice.endAt}')">延长</button>
                            <button onclick="reusePractice(${practice.id})">复用</button>
                        </td>
                    </tr>
                `;
            $practiceListTbody.append(row);
        });
    }

    function formatDisplayDateTime(dateTimeStr) {
        if (!dateTimeStr) return "";
        try {
            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) return dateTimeStr;

            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);
            const hours = ('0' + date.getHours()).slice(-2);
            const minutes = ('0' + date.getMinutes()).slice(-2);
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        } catch (e) {
            return dateTimeStr;
        }
    }

    function getStatusDisplay(status) {
        switch (status) {
            case 'not_started':
                return {text: '未开始'};
            case 'in_progress':
                return {text: '进行中'};
            case 'ended':
                return {text: '已结束'};
            default:
                return {text: status || '未知'};
        }
    }
</script>

</body>
</html>