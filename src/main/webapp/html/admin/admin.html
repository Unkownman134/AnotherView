<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员工作台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="icon" href="/Anotherview/favicon.ico" type="image/x-icon"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            transition: background-color 0.3s ease;
            overflow-x: hidden;
        }

        .transition-all {
            transition: all 0.3s ease-in-out;
        }

        .sidebar-button.active {
            background: linear-gradient(90deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .sidebar {
            position: relative;
            transition: width 0.3s ease;
            overflow: hidden;
        }

        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(59, 130, 246, 0.5), transparent);
            animation: sidebar-glow 3s infinite;
        }

        @keyframes sidebar-glow {
            0% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.7;
            }
            100% {
                opacity: 0.3;
            }
        }

        #personal-info-content .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e5e7eb;
        }

        #personal-info-content .info-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        #personal-info-content .info-item i {
            margin-right: 10px;
            color: #3b82f6;
            font-size: 1.1rem;
        }

        #personal-info-content strong {
            color: #1f2937;
            margin-right: 8px;
        }

        tbody tr {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        tbody tr.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        tbody tr:hover {
            transform: translateX(5px);
            box-shadow: -5px 0 0 #3b82f6;
        }

        .status-active {
            color: #22c55e;
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }

        .status-inactive {
            color: #ef4444;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        .status-archived {
            color: #6b7280;
            text-shadow: 0 0 10px rgba(107, 114, 128, 0.3);
        }

        .status-easy {
            color: #22c55e;
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }

        .status-medium {
            color: #f59e0b;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }

        .status-hard {
            color: #ef4444;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        .badge {
            position: relative;
            display: inline-block;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            overflow: hidden;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans leading-normal tracking-normal">

<header class="bg-white p-4 shadow-lg flex justify-between items-center animate__animated animate__fadeIn">
    <div class="flex items-center">
        <i class="fas fa-user-shield text-blue-600 text-2xl mr-3" aria-hidden="true"></i>
        <h1 class="text-xl font-bold text-gray-800">管理员工作台</h1>
    </div>
    <div class="user-info text-gray-600 flex items-center" role="region" aria-label="用户信息">
        <i class="fas fa-user-circle text-blue-500 mr-2" aria-hidden="true"></i>
        欢迎, <span id="username" class="font-semibold mx-1">加载中...</span> |
        <a href="#" onclick="logout()" class="text-blue-600 hover:text-blue-800 ml-2 transition-all flex items-center"
           role="button">
            <span>退出登录</span>
            <i class="fas fa-sign-out-alt ml-1" aria-hidden="true"></i>
        </a>
    </div>
</header>

<div class="flex min-h-screen">
    <aside class="sidebar w-56 bg-gray-800 text-white p-4" role="navigation"
           aria-label="主导航">
        <div class="sidebar-item mb-6">
            <button class="sidebar-button w-full text-left py-3 px-4 rounded-md transition duration-300 ease-in-out active flex items-center"
                    onclick="navigateTo('dashboard')" aria-current="page">
                <i class="fas fa-tachometer-alt mr-3" aria-hidden="true"></i>
                <span>仪表盘</span>
            </button>
        </div>
        <div class="sidebar-item mb-6">
            <button class="sidebar-button w-full text-left py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center"
                    onclick="navigateTo('class-management')" aria-current="false">
                <i class="fas fa-chalkboard mr-3" aria-hidden="true"></i>
                <span>班级管理</span>
            </button>
        </div>
        <div class="sidebar-item mb-6">
            <button class="sidebar-button w-full text-left py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center"
                    onclick="navigateTo('teacher-management')" aria-current="false">
                <i class="fas fa-chalkboard-teacher mr-3" aria-hidden="true"></i>
                <span>教师管理</span>
            </button>
        </div>
        <div class="sidebar-item mb-6">
            <button class="sidebar-button w-full text-left py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center"
                    onclick="navigateTo('course-management')" aria-current="false">
                <i class="fas fa-book mr-3" aria-hidden="true"></i>
                <span>课程管理</span>
            </button>
        </div>
        <div class="sidebar-item mb-6">
            <button class="sidebar-button w-full text-left py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center"
                    onclick="navigateTo('student-management')" aria-current="false">
                <i class="fas fa-user-graduate mr-3" aria-hidden="true"></i>
                <span>学生管理</span>
            </button>
        </div>
        <div class="sidebar-item mb-6">
            <button class="sidebar-button w-full text-left py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center"
                    onclick="navigateTo('question-management')" aria-current="false">
                <i class="fas fa-question-circle mr-3" aria-hidden="true"></i>
                <span>题目管理</span>
            </button>
        </div>
        <div class="sidebar-item mb-6">
            <button class="sidebar-button w-full text-left py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center"
                    onclick="navigateTo('semester-management')" aria-current="false">
                <i class="fas fa-calendar-alt mr-3" aria-hidden="true"></i>
                <span>学期管理</span>
            </button>
        </div>
        <div class="sidebar-item mb-6">
            <button class="sidebar-button w-full text-left py-3 px-4 rounded-md transition duration-300 ease-in-out flex items-center"
                    onclick="navigateTo('profile')" aria-current="false">
                <i class="fas fa-user mr-3" aria-hidden="true"></i>
                <span>个人信息</span>
            </button>
        </div>
    </aside>

    <main class="content flex-1 p-6 bg-gray-50 animate__animated animate__fadeIn" role="main">
        <section id="dashboard-section" class="card bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 id="dashboard-heading"
                class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center">
                <i class="fas fa-tachometer-alt text-blue-500 mr-3" aria-hidden="true"></i>
                仪表盘
            </h2>
            <div class="text-center py-8 text-gray-500">
                <p>欢迎来到管理员仪表盘！</p>
                <p>您的姓名是：<span class="font-bold text-blue-600" id="dashboard-admin-name"></span></p>
            </div>
        </section>

        <section id="class-management-section" class="card bg-white p-6 rounded-lg shadow-md mb-6"
                 style="display: none;">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center">
                <i class="fas fa-chalkboard text-blue-500 mr-3" aria-hidden="true"></i>
                <span>班级管理</span>
            </h2>
            <div class="text-center py-8 text-gray-500">
                <p>班级管理内容将在此处显示。</p>
            </div>
        </section>

        <section id="teacher-management-section" class="card bg-white p-6 rounded-lg shadow-md mb-6"
                 style="display: none;">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center">
                <i class="fas fa-chalkboard-teacher text-blue-500 mr-3" aria-hidden="true"></i>
                <span>教师管理</span>
            </h2>
            <div class="controls mb-6 flex flex-col sm:flex-row sm:items-end gap-4">
                <div class="flex flex-col flex-grow">
                    <label for="teacher-name-filter"
                           class="block text-gray-700 text-sm font-bold mb-1 flex items-center">
                        <i class="fas fa-filter text-blue-500 mr-2" aria-hidden="true"></i>
                        筛选姓名:
                    </label>
                    <input type="text" id="teacher-name-filter"
                           placeholder="输入教师姓名"
                           class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                           aria-label="筛选教师姓名">
                </div>

                <div class="flex flex-col flex-grow">
                    <label for="teacher-email-filter"
                           class="block text-gray-700 text-sm font-bold mb-1 flex items-center">
                        <i class="fas fa-filter text-blue-500 mr-2" aria-hidden="true"></i>
                        筛选邮箱:
                    </label>
                    <input type="email" id="teacher-email-filter"
                           placeholder="输入教师邮箱"
                           class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                           aria-label="筛选教师邮箱">
                </div>

                <div class="flex items-end flex-grow relative">
                    <i class="fas fa-search absolute left-3 bottom-2 text-gray-400" aria-hidden="true"></i>
                    <label for="teacher-search-input" class="sr-only">搜索教师</label>
                    <input type="text" id="teacher-search-input"
                           placeholder="搜索教师姓名或邮箱..."
                           class="shadow appearance-none border rounded-lg flex-grow py-2 pl-10 pr-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                           aria-label="搜索教师姓名或邮箱">
                    <button onclick="loadTeachers()"
                            class="btn ml-2 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all flex items-center justify-center h-auto"
                            aria-label="搜索">
                        <i class="fas fa-search mr-1" aria-hidden="true"></i>搜索
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm" role="region"
                 aria-labelledby="teacher-list-heading">
                <h3 id="teacher-list-heading" class="sr-only">教师列表</h3>
                <table class="min-w-full bg-white">
                    <thead>
                    <tr class="bg-gradient-to-r from-blue-50 to-blue-100 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left" scope="col">教师ID</th>
                        <th class="py-3 px-6 text-left" scope="col">姓名</th>
                        <th class="py-3 px-6 text-left" scope="col">邮箱</th>
                        <th class="py-3 px-6 text-left" scope="col">关联班级</th>
                        <th class="py-3 px-6 text-left" scope="col">操作</th>
                    </tr>
                    </thead>
                    <tbody id="teacher-list" class="text-gray-600 text-sm">
                    </tbody>
                </table>
                <div id="loading-teachers-message" class="text-center py-8 text-gray-500" style="display: none;"
                     aria-live="polite">
                    <div class="loader mb-3" role="status" aria-label="加载中"></div>
                    <p>正在加载教师数据...</p>
                </div>
                <div id="no-teachers-data-message" class="text-center py-8 text-gray-500" style="display: none;"
                     aria-live="polite">
                    <i class="fas fa-users-slash text-4xl mb-2 text-gray-300" aria-hidden="true"></i>
                    <p>没有找到教师数据。</p>
                </div>
            </div>
        </section>

        <section id="course-management-section" class="card bg-white p-6 rounded-lg shadow-md mb-6"
                 style="display: none;">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center">
                <i class="fas fa-book text-blue-500 mr-3" aria-hidden="true"></i>
                <span>课程管理</span>
            </h2>
            <div class="text-center py-8 text-gray-500">
                <p>课程管理内容将在此处显示。</p>
            </div>
        </section>

        <section id="student-management-section" class="card bg-white p-6 rounded-lg shadow-md mb-6"
                 style="display: none;">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center">
                <i class="fas fa-user-graduate text-blue-500 mr-3" aria-hidden="true"></i>
                <span>学生管理</span>
            </h2>
            <div class="text-center py-8 text-gray-500">
                <p>学生管理内容将在此处显示。</p>
            </div>
        </section>

        <section id="question-management-section" class="card bg-white p-6 rounded-lg shadow-md mb-6"
                 style="display: none;">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center">
                <i class="fas fa-question-circle text-blue-500 mr-3" aria-hidden="true"></i>
                <span>题目管理</span>
            </h2>
            <div class="controls mb-6 flex flex-col sm:flex-row sm:items-end gap-4">
                <div class="flex flex-col flex-grow">
                    <label for="question-type-filter"
                           class="block text-gray-700 text-sm font-bold mb-1 flex items-center">
                        <i class="fas fa-filter text-blue-500 mr-2" aria-hidden="true"></i>
                        筛选类型:
                    </label>
                    <select id="question-type-filter"
                            class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <option value="all">所有类型</option>
                        <option value="single_choice">单选题</option>
                        <option value="multiple_choice">多选题</option>
                        <option value="fill_blank">填空题</option>
                        <option value="essay">问答题</option>
                    </select>
                </div>

                <div class="flex flex-col flex-grow">
                    <label for="question-difficulty-filter"
                           class="block text-gray-700 text-sm font-bold mb-1 flex items-center">
                        <i class="fas fa-filter text-blue-500 mr-2" aria-hidden="true"></i>
                        筛选难度:
                    </label>
                    <select id="question-difficulty-filter"
                            class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <option value="all">所有难度</option>
                        <option value="easy">简单</option>
                        <option value="medium">中等</option>
                        <option value="hard">困难</option>
                    </select>
                </div>

                <div class="flex flex-col flex-grow">
                    <label for="lesson-id-filter" class="block text-gray-700 text-sm font-bold mb-1 flex items-center">
                        <i class="fas fa-filter text-blue-500 mr-2" aria-hidden="true"></i>
                        筛选课程ID:
                    </label>
                    <input type="number" id="lesson-id-filter"
                           placeholder="输入课程ID"
                           class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                           aria-label="筛选课程ID">
                </div>

                <div class="flex items-end flex-grow relative">
                    <i class="fas fa-search absolute left-3 bottom-2 text-gray-400" aria-hidden="true"></i>
                    <label for="question-search-input" class="sr-only">搜索题目</label>
                    <input type="text" id="question-search-input"
                           placeholder="搜索题干内容..."
                           class="shadow appearance-none border rounded-lg flex-grow py-2 pl-10 pr-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                           aria-label="搜索题目内容">
                    <button onclick="loadQuestions()"
                            class="btn ml-2 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all flex items-center justify-center h-auto"
                            aria-label="搜索">
                        <i class="fas fa-search mr-1" aria-hidden="true"></i>搜索
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm" role="region"
                 aria-labelledby="question-list-heading">
                <h3 id="question-list-heading" class="sr-only">题目列表</h3>
                <table class="min-w-full bg-white">
                    <thead>
                    <tr class="bg-gradient-to-r from-blue-50 to-blue-100 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left" scope="col">题目ID</th>
                        <th class="py-3 px-6 text-left" scope="col">课程ID</th>
                        <th class="py-3 px-6 text-left" scope="col">题干内容</th>
                        <th class="py-3 px-6 text-left" scope="col">类型</th>
                        <th class="py-3 px-6 text-left" scope="col">难度</th>
                        <th class="py-3 px-6 text-left" scope="col">分值</th>
                    </tr>
                    </thead>
                    <tbody id="question-list" class="text-gray-600 text-sm">
                    </tbody>
                </table>
                <div id="loading-questions-message" class="text-center py-8 text-gray-500" style="display: none;"
                     aria-live="polite">
                    <div class="loader mb-3" role="status" aria-label="加载中"></div>
                    <p>正在加载题目数据...</p>
                </div>
                <div id="no-questions-data-message" class="text-center py-8 text-gray-500" style="display: none;"
                     aria-live="polite">
                    <i class="fas fa-search text-4xl mb-2 text-gray-300" aria-hidden="true"></i>
                    <p>没有找到匹配的题目。</p>
                </div>
            </div>
        </section>

        <section id="semester-management-section" class="card bg-white p-6 rounded-lg shadow-md mb-6"
                 style="display: none;">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center">
                <i class="fas fa-calendar-alt text-blue-500 mr-3" aria-hidden="true"></i>
                <span>学期管理</span>
            </h2>
            <div class="text-center py-8 text-gray-500">
                <p>学期管理内容将在此处显示。</p>
            </div>
        </section>

        <section id="personal-info-section" class="card bg-white p-6 rounded-lg shadow-md mb-6" style="display: none;">
            <h2 id="personal-info-heading"
                class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4 flex items-center">
                <i class="fas fa-user text-blue-500 mr-3" aria-hidden="true"></i>
                <span>个人信息</span>
            </h2>
            <div id="personal-info-content" class="text-gray-700">
                <div class="loader mb-3" role="status" aria-label="加载中"></div>
                <p class="text-center">正在加载个人信息...</p>
            </div>
        </section>
    </main>
</div>

<div id="select-class-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 animate__animated animate__fadeIn">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md animate__animated animate__zoomIn">
        <h3 id="select-class-modal-title" class="text-xl font-bold mb-4 text-gray-800 border-b pb-3">为教师选班</h3>
        <div id="modal-class-list" class="mb-4 max-h-60 overflow-y-auto">
            <div class="loader mb-3" role="status" aria-label="加载中"></div>
            <p class="text-center text-gray-500">正在加载班级列表...</p>
        </div>
        <div class="flex justify-end gap-3">
            <button onclick="closeSelectClassModal()"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-300 transition-all">
                取消
            </button>
            <button id="select-class-modal-save-btn" onclick="saveTeacherClass()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all">
                保存
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script>
    let allClassesMap = new Map();
    let currentTeacherId = null;
    let currentTeacherName = null;
    let allTeachersData = [];

    $(document).ready(function () {
        animateEntranceSequence();

        $.get("/Anotherview/api/adminInfo", function (response) {
            if (response.success && response.admin) {
                const admin = response.admin;
                $("#username").text(admin.name);
                $("#dashboard-admin-name").text(admin.name);
                showNotification("管理员信息加载成功！", "success");
                navigateTo('dashboard'); // Default to dashboard
            } else {
                showNotification("无法获取管理员信息，请重新登录", "error");
                setTimeout(() => {
                    window.location.href = "/Anotherview/html/admin/admin-login.html";
                }, 2000);
            }
        }).fail((xhr) => {
            const errorMessage = xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText || "未知错误";
            showNotification("无法获取管理员信息: " + errorMessage + "，请重新登录", "error");
            setTimeout(() => {
                window.location.href = "/Anotherview/html/admin/admin-login.html";
            }, 2000);
        });

        $("#question-type-filter, #question-difficulty-filter").on('change', function () {
            loadQuestions();
        });

        $("#question-search-input").on('input', function () {
            clearTimeout(this.searchTimer);
            this.searchTimer = setTimeout(() => {
                loadQuestions();
            }, 300);
        });
        $("#lesson-id-filter").on('input', function () {
            clearTimeout(this.lessonIdTimer);
            this.lessonIdTimer = setTimeout(() => {
                loadQuestions();
            }, 300);
        });

        $("#teacher-name-filter, #teacher-email-filter").on('input', function () {
            clearTimeout(this.filterTimer);
            this.filterTimer = setTimeout(() => {
                renderTeachers(allTeachersData);
            }, 300);
        });

        $("#teacher-search-input").on('input', function () {
            clearTimeout(this.searchTimer);
            this.searchTimer = setTimeout(() => {
                renderTeachers(allTeachersData);
            }, 300);
        });


        $(".sidebar-button").removeClass("active").attr("aria-current", "false");
        $('.sidebar-button').each(function () {
            if ($(this).attr('onclick').includes("navigateTo('dashboard')")) {
                $(this).addClass('active').attr("aria-current", "page");
            }
        });

        loadAllClasses();
    });

    function animateEntranceSequence() {
        document.getElementById('dashboard-section').classList.add('animate__animated', 'animate__fadeIn');
    }

    function logout() {
        showNotification("正在退出登录...", "info");

        $.post("/Anotherview/api/adminLogout", function () {
            showNotification("已成功退出登录", "success");
            setTimeout(() => {
                window.location.href = "/Anotherview/html/admin/admin-login.html";
            }, 1000);
        }).fail(() => {
            showNotification("退出失败，请重试", "error");
        });
    }

    function navigateTo(page) {
        $(".sidebar-button").removeClass("active").attr("aria-current", "false");

        $("#dashboard-section").hide();
        $("#class-management-section").hide();
        $("#teacher-management-section").hide();
        $("#course-management-section").hide();
        $("#student-management-section").hide();
        $("#question-management-section").hide();
        $("#semester-management-section").hide();
        $("#personal-info-section").hide();

        $('.sidebar-button').each(function () {
            if ($(this).attr('onclick').includes(`('${page}')`)) {
                $(this).addClass('active').attr("aria-current", "page");
            }
        });

        if (page === 'dashboard') {
            $("#dashboard-section").show();
            // Removed loadDashboardSummary() call
        } else if (page === 'class-management') {
            $("#class-management-section").show();
        } else if (page === 'teacher-management') {
            $("#teacher-management-section").show();
            loadTeachers();
        } else if (page === 'course-management') {
            $("#course-management-section").show();
        } else if (page === 'student-management') {
            $("#student-management-section").show();
        } else if (page === 'question-management') {
            $("#question-management-section").show();
            loadQuestions();
        } else if (page === 'semester-management') {
            $("#semester-management-section").show();
        } else if (page === 'profile') {
            $("#personal-info-section").show();
            loadPersonalInfo();
        }
    }

    function loadPersonalInfo() {
        const $personalInfoContent = $("#personal-info-content");
        $personalInfoContent.html(`
            <div class="loader mb-3" role="status" aria-label="加载中"></div>
            <p class="text-center">正在加载个人信息...</p>
        `);

        $.get("/Anotherview/api/adminInfo", function (response) {
            $personalInfoContent.empty();
            if (response.success && response.admin) {
                const admin = response.admin;
                $personalInfoContent.append(`
                    <div class="info-item"><i class="fas fa-id-card" aria-hidden="true"></i><strong>管理员ID:</strong> ${admin.id || 'N/A'}</div>
                    <div class="info-item"><i class="fas fa-user" aria-hidden="true"></i><strong>姓名:</strong> ${admin.name || 'N/A'}</div>
                    <div class="info-item"><i class="fas fa-envelope" aria-hidden="true"></i><strong>邮箱:</strong> ${admin.email || 'N/A'}</div>
                    <div class="info-item"><i class="fas fa-calendar-alt" aria-hidden="true"></i><strong>创建日期:</strong> ${admin.createdAt ? formatDisplayDateTime(admin.createdAt) : 'N/A'}</div>
                    <div class="info-item"><i class="fas fa-clock" aria-hidden="true"></i><strong>上次登录:</strong> ${admin.lastLogin ? formatDisplayDateTime(admin.lastLogin) : 'N/A'}</div>
                    `);
            } else {
                $personalInfoContent.html(`
                    <i class="fas fa-exclamation-circle text-4xl mb-2 text-red-400" aria-hidden="true"></i>
                    <p class="text-center">无法获取个人信息。</p>
                 `);
                showNotification("无法获取个人信息", "error");
            }
        }).fail((xhr, status, error) => {
            console.error("加载个人信息失败:", error);
            $personalInfoContent.html(`
                <i class="fas fa-exclamation-circle text-4xl mb-2 text-red-400" aria-hidden="true"></i>
                <p class="text-center">加载个人信息失败。</p>
             `);
            showNotification('加载个人信息失败: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText), "error");
        });
    }

    function loadQuestions() {
        $("#loading-questions-message").show();
        $("#no-questions-data-message").hide();
        $("#question-list").empty();

        for (let i = 0; i < 5; i++) {
            $("#question-list").append(`
                <tr>
                    <td colspan="6" class="py-4"> <div class="shimmer w-full h-10 rounded-md"></div>
                    </td>
                </tr>
            `);
        }

        const typeFilter = $('#question-type-filter').val();
        const difficultyFilter = $('#question-difficulty-filter').val();
        const lessonIdFilter = $('#lesson-id-filter').val();
        const searchTerm = $("#question-search-input").val().trim();

        $.get("/Anotherview/api/adminInfo", {action: "getQuestions"}, function (response) {
            $("#question-list").empty();
            $("#loading-questions-message").hide();

            if (response.success && response.questions && response.questions.length > 0) {
                let filteredQuestions = response.questions.filter(question => {
                    const matchesType = typeFilter === 'all' || question.type === typeFilter;
                    const matchesDifficulty = difficultyFilter === 'all' || question.difficulty === difficultyFilter;
                    const matchesSearch = searchTerm === '' ||
                        question.content.includes(searchTerm);
                    const matchesLessonId = lessonIdFilter === '' || parseInt(lessonIdFilter) === question.lessonId;
                    return matchesType && matchesDifficulty && matchesSearch && matchesLessonId;
                });
                renderQuestions(filteredQuestions);
            } else {
                $("#no-questions-data-message").show();
            }
        }).fail((xhr, status, error) => {
            $("#question-list").empty();
            $("#loading-questions-message").hide();
            $("#no-questions-data-message").show().find('p').text('加载题目数据失败。');
            showNotification('加载题目数据失败: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText), "error");
            console.error("Error loading questions:", error, xhr.responseText);
        });
    }

    function renderQuestions(questions) {
        const $questionListTbody = $("#question-list");
        $questionListTbody.empty();

        if (!questions || questions.length === 0) {
            $("#no-questions-data-message").show();
            return;
        } else {
            $("#no-questions-data-message").hide();
        }

        questions.forEach((question, index) => {
            const typeDisplay = getQuestionTypeDisplay(question.type);
            const difficultyDisplay = getDifficultyDisplay(question.difficulty);
            const row = $(`
                <tr class="border-b border-gray-200 hover:bg-blue-50" data-index="${index}">
                    <td class="py-3 px-6 text-left font-semibold">${question.id || 'N\A'}</td>
                    <td class="py-3 px-6 text-left">${question.lessonId || 'N\A'}</td>
                    <td class="py-3 px-6 text-left max-w-xs overflow-hidden text-ellipsis whitespace-nowrap" title="${question.content}">${question.content || 'N\A'}</td>
                    <td class="py-3 px-6 text-left">
                        <span class="badge bg-blue-100 border border-blue-300 text-blue-800">${typeDisplay}</span>
                    </td>
                    <td class="py-3 px-6 text-left">
                        <span class="badge bg-gray-100 border border-gray-300 ${difficultyDisplay.class}">${difficultyDisplay.text}</span>
                    </td>
                    <td class="py-3 px-6 text-left">${question.score || 'N\A'}</td>
                </tr>
            `);
            $questionListTbody.append(row);
            setTimeout(() => {
                row.addClass('fade-in');
            }, 50 * index);
        });
    }

    function loadTeachers() {
        $("#loading-teachers-message").show();
        $("#no-teachers-data-message").hide();
        $("#teacher-list").empty();

        for (let i = 0; i < 5; i++) {
            $("#teacher-list").append(`
                <tr>
                    <td colspan="5" class="py-4"> <div class="shimmer w-full h-10 rounded-md"></div></td>
                </tr>
            `);
        }

        $.get("/Anotherview/api/adminInfo", {action: "getTeachers"}, function (response) {
            $("#teacher-list").empty();
            $("#loading-teachers-message").hide();

            if (response.success && response.teachers && response.teachers.length > 0) {
                allTeachersData = response.teachers;
                renderTeachers(allTeachersData);
            } else {
                $("#no-teachers-data-message").show();
            }
        }).fail((xhr) => {
            $("#teacher-list").empty();
            $("#loading-teachers-message").hide();
            $("#no-teachers-data-message").show().find('p').text('加载教师数据失败。');
            showNotification('加载教师数据失败: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText), "error");
        });
    }

    function renderTeachers(teachers) {
        const $teacherListTbody = $("#teacher-list");
        $teacherListTbody.empty();

        const nameFilter = $('#teacher-name-filter').val().toLowerCase().trim();
        const emailFilter = $('#teacher-email-filter').val().toLowerCase().trim();
        const searchTerm = $("#teacher-search-input").val().toLowerCase().trim();

        let filteredTeachers = teachers.filter(teacher => {
            const matchesName = nameFilter === '' || (teacher.name && teacher.name.toLowerCase().includes(nameFilter));
            const matchesEmail = emailFilter === '' || (teacher.email && teacher.email.toLowerCase().includes(emailFilter));
            const matchesSearch = searchTerm === '' ||
                (teacher.name && teacher.name.toLowerCase().includes(searchTerm)) ||
                (teacher.email && teacher.email.toLowerCase().includes(searchTerm));
            return matchesName && matchesEmail && matchesSearch;
        });

        if (!filteredTeachers || filteredTeachers.length === 0) {
            $("#no-teachers-data-message").show();
            return;
        } else {
            $("#no-teachers-data-message").hide();
        }

        filteredTeachers.forEach((teacher, index) => {
            $.get("/Anotherview/api/adminInfo", {action: "getTeacherClasses", teacherId: teacher.id}, function (classResponse) {
                let associatedClassName = "未分配";
                let associatedClassId = -1;
                if (classResponse.success && classResponse.associatedClassIds && classResponse.associatedClassIds.length > 0) {
                    associatedClassId = classResponse.associatedClassIds[0];
                    associatedClassName = allClassesMap.get(associatedClassId) || `ID: ${associatedClassId}`;
                }

                const row = $(`
                    <tr class="border-b border-gray-200 hover:bg-blue-50" data-index="${index}">
                        <td class="py-3 px-6 text-left font-semibold">${teacher.id || 'N\A'}</td>
                        <td class="py-3 px-6 text-left">${teacher.name || 'N\A'}</td>
                        <td class="py-3 px-6 text-left">${teacher.email || 'N\A'}</td>
                        <td class="py-3 px-6 text-left" id="teacher-${teacher.id}-class-name">${associatedClassName}</td>
                        <td class="py-3 px-6 text-left">
                            <button onclick="openSelectClassModal(${teacher.id}, '${teacher.name}', ${associatedClassId})"
                                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all flex items-center justify-center">
                                <i class="fas fa-edit mr-1"></i>选班
                            </button>
                        </td>
                    </tr>
                `);
                $teacherListTbody.append(row);
                setTimeout(() => {
                    row.addClass('fade-in');
                }, 50 * index);
            }).fail(() => {
                const row = $(`
                    <tr class="border-b border-gray-200 hover:bg-blue-50" data-index="${index}">
                        <td class="py-3 px-6 text-left font-semibold">${teacher.id || 'N\A'}</td>
                        <td class="py-3 px-6 text-left">${teacher.name || 'N\A'}</td>
                        <td class="py-3 px-6 text-left">${teacher.email || 'N\A'}</td>
                        <td class="py-3 px-6 text-left">加载失败</td>
                        <td class="py-3 px-6 text-left">
                            <button onclick="openSelectClassModal(${teacher.id}, '${teacher.name}', -1)"
                                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 transition-all flex items-center justify-center">
                                <i class="fas fa-edit mr-1"></i>选班
                            </button>
                        </td>
                    </tr>
                `);
                $teacherListTbody.append(row);
                setTimeout(() => {
                    row.addClass('fade-in');
                }, 50 * index);
            });
        });
    }

    function loadAllClasses() {
        $.get("/Anotherview/api/adminInfo", {action: "getClasses"}, function (response) {
            if (response.success && response.classes && response.classes.length > 0) {
                allClassesMap.clear();
                response.classes.forEach(cls => {
                    allClassesMap.set(cls.id, cls.name);
                });
            } else {
                console.error("Failed to load all classes:", response.message);
                showNotification("加载班级列表失败！", "error");
            }
        }).fail((xhr) => {
            console.error("Error fetching all classes:", xhr);
            showNotification('加载班级列表失败: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText), "error");
        });
    }

    function openSelectClassModal(teacherId, teacherName, currentClassId) {
        currentTeacherId = teacherId;
        currentTeacherName = teacherName;
        $("#select-class-modal-title").text(`为 ${teacherName} 选班`);
        const $classList = $("#modal-class-list");
        $classList.empty();

        if (allClassesMap.size === 0) {
            $classList.html('<p class="text-gray-600 text-center">没有可用的班级。</p>');
            $("#select-class-modal-save-btn").prop('disabled', true);
        } else {
            allClassesMap.forEach((className, classId) => {
                const isChecked = classId === currentClassId ? 'checked' : '';
                $classList.append(`
                    <label class="inline-flex items-center mt-3 p-2 rounded-md hover:bg-blue-50 cursor-pointer transition-all w-full">
                        <input type="radio" class="form-radio h-5 w-5 text-blue-600" name="selectedClass" value="${classId}" ${isChecked}>
                        <span class="ml-2 text-gray-700">${className}</span>
                    </label>
                `);
            });
            $("#select-class-modal-save-btn").prop('disabled', false);
        }

        $("#select-class-modal").removeClass("hidden").addClass("flex");
    }

    function saveTeacherClass() {
        const selectedClassId = $('input[name="selectedClass"]:checked').val();
        if (!selectedClassId) {
            showNotification("请选择一个班级！", "warning");
            return;
        }

        showNotification("正在保存班级关联...", "info");
        $("#select-class-modal-save-btn").prop('disabled', true);

        $.post("/Anotherview/api/adminInfo", {
            action: "updateTeacherClasses",
            teacherId: currentTeacherId,
            classIds: selectedClassId
        }, function (response) {
            if (response.success) {
                showNotification("班级关联更新成功！", "success");
                closeSelectClassModal();
                loadTeachers(); // 重新加载教师列表以反映更改
            } else {
                showNotification("班级关联更新失败: " + response.message, "error");
            }
            $("#select-class-modal-save-btn").prop('disabled', false);
        }).fail((xhr) => {
            showNotification('班级关联更新失败: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.responseText), "error");
            $("#select-class-modal-save-btn").prop('disabled', false);
        });
    }

    function closeSelectClassModal() {
        $("#select-class-modal").addClass("hidden").removeClass("flex");
        currentTeacherId = null;
        currentTeacherName = null;
    }

    function showNotification(message, type = 'info') {
        const existingNotification = document.getElementById('custom-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        let icon, bgColor, textColor;
        switch (type) {
            case 'success':
                icon = 'fas fa-check-circle';
                bgColor = 'bg-green-500';
                textColor = 'text-white';
                break;
            case 'error':
                icon = 'fas fa-exclamation-circle';
                bgColor = 'bg-red-500';
                textColor = 'text-white';
                break;
            case 'warning':
                icon = 'fas fa-exclamation-triangle';
                bgColor = 'bg-yellow-500';
                textColor = 'text-white';
                break;
            default:
                icon = 'fas fa-info-circle';
                bgColor = 'bg-blue-500';
                textColor = 'text-white';
        }

        const notification = document.createElement('div');
        notification.id = 'custom-notification';
        notification.className = `fixed top-4 right-4 ${bgColor} ${textColor} px-6 py-3 rounded-lg shadow-lg z-50 flex items-center animate__animated animate__fadeInRight`;
        notification.setAttribute('role', 'status');
        notification.setAttribute('aria-live', 'polite');
        notification.innerHTML = `
            <i class="${icon} mr-2" aria-hidden="true"></i>
            <span>${message}</span>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.remove('animate__fadeInRight');
            notification.classList.add('animate__fadeOutRight');
            setTimeout(() => {
                notification.remove();
            }, 500);
        }, 3000);
    }

    function formatDisplayDateTime(dateTimeStr) {
        if (!dateTimeStr) return "";
        try {
            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) return dateTimeStr;

            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);
            const hours = ('0' + date.getHours()).slice(-2);
            const minutes = ('0' + date.getMinutes()).slice(-2);
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        } catch (e) {
            console.error("格式化日期失败:", dateTimeStr, e);
            return dateTimeStr;
        }
    }

    function getQuestionTypeDisplay(type) {
        switch (type) {
            case 'single_choice':
                return '单选题';
            case 'multiple_choice':
                return '多选题';
            case 'fill_blank':
                return '填空题';
            case 'essay':
                return '问答题';
            default:
                return type || '未知';
        }
    }

    function getDifficultyDisplay(difficulty) {
        switch (difficulty) {
            case 'easy':
                return {text: '简单', class: 'status-easy'};
            case 'medium':
                return {text: '中等', class: 'status-medium'};
            case 'hard':
                return {text: '困难', class: 'status-hard'};
            default:
                return {text: difficulty || '未知', class: ''};
        }
    }
</script>

</body>
</html>
